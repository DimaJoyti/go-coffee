# AI Order Management Service Makefile
# Comprehensive build and deployment automation for Go Coffee AI microservices

.PHONY: help build run test clean proto docker compose logs stop install-deps

# Default target
help: ## Show this help message
	@echo "ğŸ¤– AI Order Management Service - Available Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Variables
PROTO_DIR := api/proto
GO_OUT_DIR := api/proto
SERVICES := ai-order-service kitchen-service communication-hub user-gateway

# Build targets
build: ## Build all AI microservices
	@echo "ğŸ”¨ Building all AI microservices..."
	@for service in $(SERVICES); do \
		echo "Building $$service..."; \
		go build -o bin/$$service cmd/$$service/main.go; \
	done
	@echo "âœ… All services built successfully!"

build-ai-order: ## Build AI Order Service only
	@echo "ğŸ”¨ Building AI Order Service..."
	@go build -o bin/ai-order-service cmd/ai-order-service/main.go
	@echo "âœ… AI Order Service built!"

build-kitchen: ## Build Kitchen Service only
	@echo "ğŸ”¨ Building Kitchen Service..."
	@go build -o bin/kitchen-service cmd/kitchen-service/main.go
	@echo "âœ… Kitchen Service built!"

build-communication: ## Build Communication Hub only
	@echo "ğŸ”¨ Building Communication Hub..."
	@go build -o bin/communication-hub cmd/communication-hub/main.go
	@echo "âœ… Communication Hub built!"

build-gateway: ## Build User Gateway only
	@echo "ğŸ”¨ Building User Gateway..."
	@go build -o bin/user-gateway cmd/user-gateway/main.go
	@echo "âœ… User Gateway built!"

# Protocol Buffers
proto: ## Generate Go code from proto files
	@echo "ğŸ”„ Generating protobuf code..."
	@mkdir -p $(GO_OUT_DIR)
	@protoc --go_out=$(GO_OUT_DIR) --go_opt=paths=source_relative \
		--go-grpc_out=$(GO_OUT_DIR) --go-grpc_opt=paths=source_relative \
		$(PROTO_DIR)/*.proto
	@echo "âœ… Protobuf code generated!"

install-proto: ## Install protobuf compiler and Go plugins
	@echo "ğŸ“¦ Installing protobuf tools..."
	@go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	@go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
	@echo "âœ… Protobuf tools installed!"

# Dependencies
install-deps: ## Install Go dependencies
	@echo "ğŸ“¦ Installing Go dependencies..."
	@go mod download
	@go mod tidy
	@echo "âœ… Dependencies installed!"

# Run services
run-all: ## Run all AI microservices
	@echo "ğŸš€ Starting all AI microservices..."
	@make run-redis &
	@sleep 3
	@make run-ai-order &
	@sleep 2
	@make run-kitchen &
	@sleep 2
	@make run-communication &
	@sleep 2
	@make run-gateway &
	@echo "âœ… All services started!"

run-ai-order: ## Run AI Order Service
	@echo "ğŸš€ Starting AI Order Service..."
	@GRPC_PORT=50051 REDIS_URL=redis://localhost:6379 ./bin/ai-order-service

run-kitchen: ## Run Kitchen Service
	@echo "ğŸš€ Starting Kitchen Service..."
	@GRPC_PORT=50052 REDIS_URL=redis://localhost:6379 ./bin/kitchen-service

run-communication: ## Run Communication Hub
	@echo "ğŸš€ Starting Communication Hub..."
	@GRPC_PORT=50053 REDIS_URL=redis://localhost:6379 ./bin/communication-hub

run-gateway: ## Run User Gateway
	@echo "ğŸš€ Starting User Gateway..."
	@HTTP_PORT=8080 \
	 AI_ORDER_SERVICE_ADDR=localhost:50051 \
	 KITCHEN_SERVICE_ADDR=localhost:50052 \
	 COMMUNICATION_HUB_ADDR=localhost:50053 \
	 ./bin/user-gateway

run-redis: ## Start Redis server
	@echo "ğŸš€ Starting Redis server..."
	@docker run -d --name redis-ai-order -p 6379:6379 redis:7-alpine || docker start redis-ai-order

# Development
dev: build run-all ## Build and run all services for development

dev-ai-order: build-ai-order run-ai-order ## Build and run AI Order Service for development

dev-kitchen: build-kitchen run-kitchen ## Build and run Kitchen Service for development

dev-communication: build-communication run-communication ## Build and run Communication Hub for development

dev-gateway: build-gateway run-gateway ## Build and run User Gateway for development

# Testing
test: ## Run all tests
	@echo "ğŸ§ª Running tests..."
	@go test -v ./internal/ai-order/...
	@go test -v ./internal/kitchen/...
	@go test -v ./internal/communication/...
	@go test -v ./internal/user/...
	@echo "âœ… All tests passed!"

test-ai-order: ## Run AI Order Service tests
	@echo "ğŸ§ª Running AI Order Service tests..."
	@go test -v ./internal/ai-order/...

test-kitchen: ## Run Kitchen Service tests
	@echo "ğŸ§ª Running Kitchen Service tests..."
	@go test -v ./internal/kitchen/...

test-communication: ## Run Communication Hub tests
	@echo "ğŸ§ª Running Communication Hub tests..."
	@go test -v ./internal/communication/...

test-gateway: ## Run User Gateway tests
	@echo "ğŸ§ª Running User Gateway tests..."
	@go test -v ./internal/user/...

test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running tests with coverage..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

# Docker
docker-build: ## Build Docker images for all services
	@echo "ğŸ³ Building Docker images..."
	@docker build -t ai-order-service -f docker/Dockerfile.ai-order .
	@docker build -t kitchen-service -f docker/Dockerfile.kitchen .
	@docker build -t communication-hub -f docker/Dockerfile.communication .
	@docker build -t user-gateway -f docker/Dockerfile.gateway .
	@echo "âœ… Docker images built!"

docker-run: ## Run services using Docker
	@echo "ğŸ³ Running services with Docker..."
	@docker-compose -f docker-compose.ai-order.yml up -d
	@echo "âœ… Services started with Docker!"

compose-up: ## Start all services using docker-compose
	@echo "ğŸ³ Starting services with docker-compose..."
	@docker-compose -f docker-compose.ai-order.yml up -d
	@echo "âœ… All services started!"

compose-down: ## Stop all services using docker-compose
	@echo "ğŸ³ Stopping services with docker-compose..."
	@docker-compose -f docker-compose.ai-order.yml down
	@echo "âœ… All services stopped!"

# Monitoring and logs
logs: ## Show logs from all services
	@echo "ğŸ“‹ Showing logs from all services..."
	@docker-compose -f docker-compose.ai-order.yml logs -f

logs-ai-order: ## Show AI Order Service logs
	@echo "ğŸ“‹ Showing AI Order Service logs..."
	@docker logs -f ai-order-service

logs-kitchen: ## Show Kitchen Service logs
	@echo "ğŸ“‹ Showing Kitchen Service logs..."
	@docker logs -f kitchen-service

logs-communication: ## Show Communication Hub logs
	@echo "ğŸ“‹ Showing Communication Hub logs..."
	@docker logs -f communication-hub

logs-gateway: ## Show User Gateway logs
	@echo "ğŸ“‹ Showing User Gateway logs..."
	@docker logs -f user-gateway

# Cleanup
clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf bin/
	@rm -f coverage.out coverage.html
	@echo "âœ… Cleanup completed!"

stop: ## Stop all running services
	@echo "ğŸ›‘ Stopping all services..."
	@pkill -f ai-order-service || true
	@pkill -f kitchen-service || true
	@pkill -f communication-hub || true
	@pkill -f user-gateway || true
	@docker stop redis-ai-order || true
	@echo "âœ… All services stopped!"

# API Testing
test-api: ## Test API endpoints
	@echo "ğŸ§ª Testing API endpoints..."
	@curl -X GET http://localhost:8080/health
	@curl -X GET http://localhost:8080/api/v1/orders
	@echo "âœ… API tests completed!"

# Database operations
redis-cli: ## Connect to Redis CLI
	@echo "ğŸ”— Connecting to Redis CLI..."
	@docker exec -it redis-ai-order redis-cli

redis-flush: ## Flush Redis database
	@echo "ğŸ—‘ï¸ Flushing Redis database..."
	@docker exec redis-ai-order redis-cli FLUSHALL
	@echo "âœ… Redis database flushed!"

# Deployment
deploy-local: build docker-build compose-up ## Deploy locally with Docker
	@echo "ğŸš€ Local deployment completed!"

deploy-k8s: ## Deploy to Kubernetes
	@echo "ğŸš€ Deploying to Kubernetes..."
	@kubectl apply -f k8s/ai-order/
	@echo "âœ… Kubernetes deployment completed!"

# Utilities
format: ## Format Go code
	@echo "ğŸ¨ Formatting Go code..."
	@go fmt ./...
	@echo "âœ… Code formatted!"

lint: ## Run linter
	@echo "ğŸ” Running linter..."
	@golangci-lint run
	@echo "âœ… Linting completed!"

mod-update: ## Update Go modules
	@echo "ğŸ“¦ Updating Go modules..."
	@go get -u ./...
	@go mod tidy
	@echo "âœ… Modules updated!"

# Documentation
docs: ## Generate documentation
	@echo "ğŸ“š Generating documentation..."
	@godoc -http=:6060 &
	@echo "âœ… Documentation server started at http://localhost:6060"

# Quick start
quick-start: install-deps proto build run-redis ## Quick start for development
	@echo "ğŸš€ Quick start completed! Run 'make run-all' to start all services."
