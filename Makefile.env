# =============================================================================
# Go Coffee - Environment Management Makefile
# =============================================================================
# This Makefile provides commands for managing environment files and configuration
# =============================================================================

.PHONY: help env-setup env-validate env-test env-copy env-clean env-backup env-restore

# Default target
help: ## Show this help message
	@echo "ðŸ”§ Go Coffee Environment Management"
	@echo "=================================="
	@echo ""
	@echo "Available commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Environment files:"
	@echo "  .env                 - Main environment file"
	@echo "  .env.development     - Development environment"
	@echo "  .env.production      - Production environment"
	@echo "  .env.docker          - Docker Compose environment"
	@echo "  .env.ai-search       - AI Search Engine specific"
	@echo "  .env.web3            - Web3 services specific"
	@echo "  .env.example         - Template file"
	@echo ""

# Environment setup
env-setup: ## Setup environment files for development
	@echo "ðŸ”§ Setting up environment files..."
	@if [ ! -f .env ]; then \
		echo "ðŸ“ Creating .env from .env.example..."; \
		cp .env.example .env; \
		echo "âœ… Created .env file"; \
	else \
		echo "â„¹ï¸  .env file already exists"; \
	fi
	@if [ ! -f .env.local ]; then \
		echo "ðŸ“ Creating .env.local..."; \
		touch .env.local; \
		echo "# Local environment overrides" > .env.local; \
		echo "# Add your local-specific variables here" >> .env.local; \
		echo "âœ… Created .env.local file"; \
	else \
		echo "â„¹ï¸  .env.local file already exists"; \
	fi
	@echo "ðŸŽ‰ Environment setup completed!"
	@echo ""
	@echo "ðŸ“ Next steps:"
	@echo "  1. Edit .env file with your configuration"
	@echo "  2. Add local overrides to .env.local"
	@echo "  3. Run 'make env-validate' to check configuration"

env-validate: ## Validate environment configuration
	@echo "ðŸ” Validating environment configuration..."
	@go run cmd/config-test/main.go validate
	@echo "âœ… Environment validation completed!"

env-test: ## Test environment configuration loading
	@echo "ðŸ§ª Testing environment configuration..."
	@go run cmd/config-test/main.go
	@echo "âœ… Environment test completed!"

env-copy: ## Copy environment files for different environments
	@echo "ðŸ“‹ Copying environment files..."
	@echo "Select target environment:"
	@echo "  1) Development"
	@echo "  2) Staging"
	@echo "  3) Production"
	@echo "  4) Docker"
	@read -p "Enter choice (1-4): " choice; \
	case $$choice in \
		1) cp .env.development .env && echo "âœ… Copied development environment"; ;; \
		2) cp .env.example .env.staging && echo "âœ… Created staging environment template"; ;; \
		3) cp .env.production .env && echo "âš ï¸  Copied production environment (BE CAREFUL!)"; ;; \
		4) cp .env.docker .env && echo "âœ… Copied Docker environment"; ;; \
		*) echo "âŒ Invalid choice"; exit 1; ;; \
	esac

env-clean: ## Clean up environment files (keeps .env.example)
	@echo "ðŸ§¹ Cleaning up environment files..."
	@echo "âš ï¸  This will remove all .env files except .env.example"
	@read -p "Are you sure? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		rm -f .env .env.local .env.development.local .env.production.local; \
		echo "âœ… Environment files cleaned"; \
	else \
		echo "âŒ Operation cancelled"; \
	fi

env-backup: ## Backup current environment files
	@echo "ðŸ’¾ Backing up environment files..."
	@mkdir -p backups/env
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	if [ -f .env ]; then cp .env backups/env/.env.$$timestamp; echo "âœ… Backed up .env"; fi; \
	if [ -f .env.local ]; then cp .env.local backups/env/.env.local.$$timestamp; echo "âœ… Backed up .env.local"; fi; \
	if [ -f .env.production ]; then cp .env.production backups/env/.env.production.$$timestamp; echo "âœ… Backed up .env.production"; fi; \
	echo "ðŸ“ Backups saved to backups/env/"

env-restore: ## Restore environment files from backup
	@echo "ðŸ”„ Restoring environment files from backup..."
	@if [ ! -d backups/env ]; then \
		echo "âŒ No backup directory found"; \
		exit 1; \
	fi
	@echo "Available backups:"
	@ls -la backups/env/ | grep -E '\.(env|local)' | awk '{print "  " $$9}'
	@read -p "Enter backup filename to restore: " filename; \
	if [ -f "backups/env/$$filename" ]; then \
		cp "backups/env/$$filename" .env; \
		echo "âœ… Restored $$filename to .env"; \
	else \
		echo "âŒ Backup file not found"; \
	fi

# Environment-specific commands
env-dev: ## Switch to development environment
	@echo "ðŸ”§ Switching to development environment..."
	@cp .env.development .env
	@echo "âœ… Switched to development environment"
	@make env-validate

env-prod: ## Switch to production environment (with confirmation)
	@echo "âš ï¸  Switching to PRODUCTION environment"
	@echo "This will overwrite your current .env file!"
	@read -p "Are you sure? Type 'PRODUCTION' to confirm: " confirm; \
	if [ "$$confirm" = "PRODUCTION" ]; then \
		cp .env.production .env; \
		echo "âœ… Switched to production environment"; \
		make env-validate; \
	else \
		echo "âŒ Operation cancelled"; \
	fi

env-docker: ## Switch to Docker environment
	@echo "ðŸ³ Switching to Docker environment..."
	@cp .env.docker .env
	@echo "âœ… Switched to Docker environment"
	@make env-validate

# Security commands
env-check-secrets: ## Check for exposed secrets in environment files
	@echo "ðŸ”’ Checking for exposed secrets..."
	@echo "Checking for default/placeholder values that should be changed:"
	@echo ""
	@if grep -q "your-.*-key\|your-.*-secret\|your-.*-password\|your-.*-token" .env 2>/dev/null; then \
		echo "âš ï¸  Found placeholder values in .env:"; \
		grep --color=always "your-.*-key\|your-.*-secret\|your-.*-password\|your-.*-token" .env || true; \
		echo ""; \
	fi
	@if grep -q "postgres\|admin\|password\|secret" .env 2>/dev/null; then \
		echo "âš ï¸  Found potentially weak credentials in .env:"; \
		grep --color=always -i "password.*=.*postgres\|password.*=.*admin\|password.*=.*password\|secret.*=.*secret" .env || true; \
		echo ""; \
	fi
	@echo "âœ… Security check completed"

env-generate-secrets: ## Generate secure random secrets for environment
	@echo "ðŸ” Generating secure secrets..."
	@echo "JWT_SECRET=$$(openssl rand -hex 32)"
	@echo "API_KEY_SECRET=$$(openssl rand -hex 24)"
	@echo "WEBHOOK_SECRET=$$(openssl rand -hex 24)"
	@echo "ENCRYPTION_KEY=$$(openssl rand -hex 16)"
	@echo ""
	@echo "ðŸ’¡ Copy these values to your .env file"

# Docker-related environment commands
env-docker-up: ## Start services with Docker using environment files
	@echo "ðŸ³ Starting Docker services with environment configuration..."
	@docker-compose --env-file .env.docker up -d
	@echo "âœ… Docker services started"

env-docker-down: ## Stop Docker services
	@echo "ðŸ³ Stopping Docker services..."
	@docker-compose --env-file .env.docker down
	@echo "âœ… Docker services stopped"

env-docker-logs: ## Show Docker services logs
	@echo "ðŸ“‹ Docker services logs..."
	@docker-compose --env-file .env.docker logs -f

# Utility commands
env-show: ## Show current environment configuration (without secrets)
	@echo "ðŸ“‹ Current environment configuration:"
	@echo "===================================="
	@go run cmd/config-test/main.go

env-export: ## Export environment configuration to JSON
	@echo "ðŸ“¤ Exporting environment configuration..."
	@go run cmd/config-test/main.go export

env-diff: ## Show differences between environment files
	@echo "ðŸ“Š Environment files comparison:"
	@echo "==============================="
	@if [ -f .env ] && [ -f .env.development ]; then \
		echo "Differences between .env and .env.development:"; \
		diff -u .env .env.development || true; \
		echo ""; \
	fi
	@if [ -f .env ] && [ -f .env.production ]; then \
		echo "Differences between .env and .env.production:"; \
		diff -u .env .env.production || true; \
		echo ""; \
	fi

env-template: ## Create environment template from current .env
	@echo "ðŸ“ Creating environment template..."
	@if [ -f .env ]; then \
		sed 's/=.*/=your-value-here/' .env > .env.template; \
		echo "âœ… Created .env.template"; \
	else \
		echo "âŒ No .env file found"; \
	fi

# Build and test with environment
build-with-env: ## Build application with environment validation
	@echo "ðŸ”¨ Building application with environment validation..."
	@make env-validate
	@go build -o bin/go-coffee ./cmd/...
	@echo "âœ… Build completed with environment validation"

test-with-env: ## Run tests with environment configuration
	@echo "ðŸ§ª Running tests with environment configuration..."
	@make env-validate
	@go test ./...
	@echo "âœ… Tests completed"

# Documentation
env-docs: ## Generate environment documentation
	@echo "ðŸ“š Generating environment documentation..."
	@echo "# Go Coffee Environment Variables" > ENV_DOCS.md
	@echo "" >> ENV_DOCS.md
	@echo "This document describes all environment variables used in Go Coffee." >> ENV_DOCS.md
	@echo "" >> ENV_DOCS.md
	@echo "## Core Application Settings" >> ENV_DOCS.md
	@grep -E "^[A-Z_]+=.*" .env.example | head -20 >> ENV_DOCS.md || true
	@echo "âœ… Environment documentation generated in ENV_DOCS.md"

# Status check
env-status: ## Show environment status and health
	@echo "ðŸ“Š Environment Status"
	@echo "===================="
	@echo "Current environment files:"
	@ls -la .env* 2>/dev/null || echo "No .env files found"
	@echo ""
	@echo "Environment variable count:"
	@if [ -f .env ]; then \
		echo "  .env: $$(grep -c '^[A-Z_]*=' .env 2>/dev/null || echo 0) variables"; \
	fi
	@if [ -f .env.local ]; then \
		echo "  .env.local: $$(grep -c '^[A-Z_]*=' .env.local 2>/dev/null || echo 0) variables"; \
	fi
	@echo ""
	@make env-check-secrets
